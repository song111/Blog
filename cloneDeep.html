<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>

  <body>
    <script>
      //   oldObj.b = oldObj;

      // 类型检查
      const getType = (val) => Object.prototype.toString.call(val).slice(8, -1);

      // 构建正则
      const getRegFlags = (regExp) => {
        let flags = "";
        if (regExp.global) flags += "g";
        if (regExp.ignoreCase) flags += "i";
        if (regExp.multiline) flags += "m";
        return flags;
      };

      const initClone = (val) => {
        const type = getType(val);
        const ctor = val.constructor;
        let newObj = null;
        switch (type) {
          case "Date":
            newObj = new Date(val.getTime());
            return newObj;
          case "RegExp":
            newObj = new RegExp(val.source, getRegFlags(val));
            newObj.lastIndex = val.lastIndex;
            return newObj;
          case "Function":
            return newObj;
          default:
            newObj = Object.create(Object.getPrototypeOf(val));
        }
      };

      const isObject = (val) =>
        typeof val !== null &&
        (typeof val === "object" || typeof val === "function");

      const cloneDeep = (value, hash = new WeakMap()) => {
        if (!isObject(value)) return value;

        const type = getType(value);
        const ctor = value.constructor;
        let newObj = null;
        switch (type) {
          case "Date":
            newObj = new Date(value.getTime());
            return newObj;
          case "RegExp":
            const flags = getRegFlags(value);
            newObj = new RegExp(value.source, flags);
            newObj.lastIndex = value.lastIndex;
            return newObj;
          case "Function":
            proto = Object.getPrototypeOf(parent);
            // 利用Object.create切断原型链
            newObj = Object.create(proto);
            return value;
          default:
            newObj = Object.create(Object.getPrototypeOf(value));
        }

        // // 循环引用
        if (hash.has(value)) return hash.get(value);
        hash.set(value, newObj);

        for (let key in value) {
          newObj[key] = cloneDeep(value[key], hash);
        }

        return newObj;
      };

      //--------------------------------------test -----------------------------------------------
      function person(pname) {
        this.name = pname;
      }

      const Messi = new person("Messi");

      function say() {
        console.log("hi");
        return "hello";
      }

      class Animal {
        constructor() {
          this.type = "anmial";
        }
        say() {
          console.log(`my type is ${this.type}`);
        }
      }

      class Dog extends Animal {
        constructor() {
          super();
          this.type = "dog";
        }
      }

      console.log(getType(Dog));
      console.log("Dog", Dog);

      const oldObj = {
        a: say,
        b: new RegExp("ab+c", "i"),
        c: Messi,
        d: new Date("2020-08-15"),
        e: Dog,
      };

      oldObj.f = oldObj; // 循环引用

      const newObject = cloneDeep(oldObj);

      console.log(newObject);
      console.log(newObject.a());
      console.log(newObject.b.exec("abBc"));
      console.log(newObject.c.name);
      console.log(newObject.d.getTime());
      console.log(Dog.prototype);
      const dog = new newObject.e();
      dog.say();
    </script>
  </body>
</html>
